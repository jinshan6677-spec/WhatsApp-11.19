# 需求文档

## 简介

本功能旨在增强现有代理系统，为中国用户提供安全可靠的网络访问方案。核心改动是支持本地代理端口，让用户可以通过外部代理客户端（如 Clash、V2rayN）的本地 HTTP 端口访问 WhatsApp 和翻译服务。

**核心架构：**
```
外部代理客户端(Clash/V2rayN) → 本地HTTP端口(127.0.0.1:7890) → 应用 → [可选链式代理] → 目标
```

**解决的问题：**
1. WhatsApp 在中国被封锁，无法直接访问
2. 翻译服务（如 Google Translate）被封锁
3. 明文代理容易被 GFW 识别和封锁

## 术语表

- **本地代理端口 (Local_Proxy_Port)**: 外部代理客户端在本地创建的 HTTP 代理端口（如 Clash 的 7890 端口）
- **链式代理 (Chained_Proxy)**: 在本地代理之后可选配置的 HTTP/HTTPS 代理（用于多账号独立 IP）
- **代理链管理器 (Proxy_Chain_Manager)**: 负责管理本地代理和可选的链式代理配置
- **连接健康监控器 (Connection_Health_Monitor)**: 监控代理连接状态
- **外部代理客户端 (External_Proxy_Client)**: 用户自行安装的代理软件，如 Clash、V2rayN 等

## 需求列表

### 需求 1: 本地代理端口支持

**用户故事:** 作为中国用户，我希望应用能使用我的代理客户端的本地 HTTP 端口，这样我可以通过加密隧道访问 WhatsApp。

#### 验收标准

1. 系统 应当 支持配置本地 HTTP 代理端口（格式：`127.0.0.1:端口`）
2. 当 配置本地代理端口时，系统 应当 验证端口格式是否正确
3. 系统 应当 提供常用代理客户端的默认端口预设：
   - Clash: 7890
   - V2rayN: 10808
   - Shadowsocks: 1080
   - 自定义端口
4. 当 本地代理端口配置成功后，系统 应当 将所有 WhatsApp 流量通过该端口路由
5. 当 本地代理不可用时，系统 应当 显示友好的错误提示

### 需求 2: 链式代理配置（多账号独立 IP）

**用户故事:** 作为多账号用户，我希望在本地代理之后配置额外的 HTTP/HTTPS 代理，这样每个账号可以拥有独立的 IP 地址。

#### 验收标准

1. 当 本地代理处于活动状态时，系统 应当 允许配置可选的链式代理（HTTP/HTTPS）
2. 当 配置了链式代理时，系统 应当 按以下路径路由流量：本地代理 → 链式代理 → 目标
3. 当 未配置链式代理时，系统 应当 按以下路径路由流量：本地代理 → 目标
4. 系统 应当 支持按账号配置不同的链式代理
5. 系统 应当 在应用配置前验证链式代理是否可通过本地代理访问

### 需求 3: 翻译服务代理支持

**用户故事:** 作为中国用户，我希望翻译服务能通过代理工作，这样我可以正常使用翻译功能。

#### 验收标准

1. 当 本地代理处于活动状态时，翻译服务 应当 通过代理路由请求
2. 系统 应当 自动检测翻译服务是否被封锁，并建议启用代理
3. 当 翻译请求因网络问题失败时，系统 应当 在代理可用时通过代理重试
4. 系统 应当 支持配置翻译服务始终使用代理或自动检测

### 需求 4: 连接健康监控

**用户故事:** 作为用户，我希望系统能监控代理连接状态，这样我可以及时发现连接问题。

#### 验收标准

1. 连接健康监控器 应当 每 60 秒定期检查代理连通性
2. 当 代理连接丢失时，系统 应当 在界面显示警告提示
3. 界面 应当 用视觉指示器显示实时连接状态（绿色=已连接、黄色=连接中、红色=已断开）
4. 系统 应当 提供"测试连接"按钮，允许用户手动测试代理连通性

### 需求 5: 用户界面集成

**用户故事:** 作为用户，我希望有直观的界面来管理代理设置，这样我可以轻松配置连接。

#### 验收标准

1. 系统 应当 在现有代理设置面板中添加"本地代理"选项
2. 界面 应当 提供代理客户端预设下拉选择（Clash、V2rayN、Shadowsocks、自定义）
3. 当 选择预设时，系统 应当 自动填充对应的默认端口
4. 界面 应当 显示当前连接模式（直连、本地代理、本地代理+链式代理）
5. 当 发生连接错误时，界面 应当 显示用户友好的错误消息

### 需求 6: 错误处理

**用户故事:** 作为遇到连接问题的用户，我希望有清晰的错误消息，这样我可以排查问题。

#### 验收标准

1. 当 本地代理端口无法连接时，系统 应当 提示"请检查代理客户端是否已启动"
2. 当 链式代理无法连接时，系统 应当 区分本地代理问题和链式代理问题
3. 系统 应当 提供网络诊断功能，测试连通性（本地 → 代理 → 目标）
4. 系统 应当 记录连接事件以便排查（敏感数据需脱敏）
